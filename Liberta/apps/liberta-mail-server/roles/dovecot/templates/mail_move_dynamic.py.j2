#!/usr/bin/env python3
import os
import sys
import email
from email.utils import getaddresses
from pathlib import Path
import shutil
import time
import threading
import inotify.adapters

def capitalize_first(s):
    return s[0].upper() + s[1:] if s else s

def extract_subfolders(local_part):
    if '.' not in local_part:
        return []
    main_part = local_part.split('.', 1)[0]
    parts = main_part.split('-')
    return parts[:3]

def build_mailbox_path(subfolders):
    cap_parts = [capitalize_first(p) for p in subfolders]
    if not cap_parts:
        return None
    return "INBOX." + ".".join(cap_parts)

def create_maildir_dirs(mailbox_path):
    subdirs = ['cur', 'new', 'tmp']
    for d in [mailbox_path] + [mailbox_path / sd for sd in subdirs]:
        if not d.exists():
            d.mkdir(parents=True, exist_ok=True)

def move_mail(source_path, dest_maildir):
    dest_new = dest_maildir / 'new'
    if not dest_new.exists():
        create_maildir_dirs(dest_maildir)
    dest_path = dest_new / source_path.name
    shutil.move(str(source_path), str(dest_path))

def process_mail_file(mailfile, user_maildir, mail_domain):
    try:
        with open(mailfile, 'r') as f:
            msg = email.message_from_file(f)
        recipients = []
        for hdr in ['To', 'Cc', 'Bcc']:
            addrs = getaddresses([msg.get(hdr, "")])
            for _, addr in addrs:
                addr = addr.lower()
                if addr.endswith(f"@{mail_domain}"):
                    recipients.append(addr)
        if not recipients:
            inbox_dir = user_maildir / 'INBOX'
            if not inbox_dir.exists():
                create_maildir_dirs(inbox_dir)
            move_mail(mailfile, inbox_dir)
            return

        moved_mailboxes = set()
        for rcpt in recipients:
            local = rcpt.split('@')[0]
            subfolders = extract_subfolders(local)
            if not subfolders:
                inbox_dir = user_maildir / 'INBOX'
                if inbox_dir not in moved_mailboxes:
                    if not inbox_dir.exists():
                        create_maildir_dirs(inbox_dir)
                    move_mail(mailfile, inbox_dir)
                    moved_mailboxes.add(inbox_dir)
                continue
            mailbox = build_mailbox_path(subfolders)
            if mailbox is None:
                continue
            mailbox_path = user_maildir / mailbox.replace('.', '/')
            if mailbox_path not in moved_mailboxes:
                create_maildir_dirs(mailbox_path)
                move_mail(mailfile, mailbox_path)
                moved_mailboxes.add(mailbox_path)
    except Exception:
        pass

def process_to_process_dir(to_process_new, user_maildir, mail_domain):
    # Traiter tous les mails dans 'to-process/new'
    for mailfile in list(to_process_new.iterdir()):
        if mailfile.is_file():
            process_mail_file(mailfile, user_maildir, mail_domain)

    # Supprimer dossier to-process s’il est vide
    try:
        to_process_dir = to_process_new.parent
        if not any(to_process_dir.iterdir()):
            to_process_dir.rmdir()
    except Exception:
        pass

def watch_maildirs(mail_data_rootdir, mail_domain):
    i = inotify.adapters.Inotify()
    # Surveiller récursivement le dossier de données mail, filtrer event 'create' dans 'to-process/new'
    i.add_watch(str(mail_data_rootdir))

    for event in i.event_gen(yield_nones=False):
        (_, type_names, path, filename) = event
        if 'IN_CREATE' in type_names or 'IN_CLOSE_WRITE' in type_names:
            p = Path(path)
            if filename and p.name == 'new' and p.parent.name == 'to-process':
                user_maildir = p.parent.parent
                process_to_process_dir(p, user_maildir, mail_domain)

def main():
    mail_data_rootdir = Path("{{ mail_data_rootdir }}")
    mail_domain = "{{ mail_domain }}"
    watch_maildirs(mail_data_rootdir, mail_domain)


if __name__ == '__main__':
    main()
