dovecot_config_version = 2.4.1
dovecot_storage_version = 2.4.1

# On active les protocoles LMTP (pour l'interne) et IMAP :
protocols = lmtp imap

# Activation du plugin de gestion des quotas :
mail_plugins {
	quota = yes
}

# Configuration IMAP (désactivé) et IMAPS :
service imap-login {
	inet_listener imap {
		port = 0
	}
	inet_listener imaps {
		port = 993
	}
}

# Protocole IMAP : contournement de certains bugs et contraintes
# + quota + alias + chiffrement :

protocol imap {
	mail_plugins {
		quota = yes
		sieve = yes
		mailbox_alias = yes
		mail_crypt = yes
	}
	# TODO:
	#imap_client_workarounds = delay-newmail tb-extra-mailbox-sep
}

# Protocoles LDA/LMTP : activation quota + règles Sieve de déplacement
# des Spams + alias + chiffrement :
protocol lda {
	mail_plugins {
		quota = yes
		sieve = yes
		mailbox_alias = yes
		mail_crypt = yes
	}
}

lmtp_rcpt_check_quota = yes
protocol lmtp {
	mail_plugins {
		quota = yes
		sieve = yes
		mailbox_alias = yes
		mail_crypt = yes
  }
  postmaster_address = postmaster@{{ mail_domain }}
}

# Emplacement des boites e-mail :
mail_driver = maildir
mail_path = {{ mail_data_rootdir }}/%{domain}/%{username}
mail_home = %{home}/Maildir

# Emplacement des attributs de chaque boite mail :
mail_attribute {
	dict file {
		path = %{home}/dovecot-attributes
	}
}

# Configuration SSL (algos) :
ssl = yes
ssl_server_prefer_ciphers = client
ssl_server_dh_file = /etc/dovecot/dh.pem
ssl_min_protocol = TLSv1.2
ssl_cipher_list = ALL:!aNULL:!DES:!3DES:!MD5:!DES+MD5:!RC4

# Certificats Let's Encrypt :
ssl_server_cert_file = /etc/letsencrypt/live/{{ mail_fqdn }}/fullchain.pem
ssl_server_key_file  = /etc/letsencrypt/live/{{ mail_fqdn }}/privkey.pem

# Configuration des logins :
auth_mechanisms = plain login
auth_allow_cleartext = yes

# Message d'accueil :
login_greeting = "Mail Delivery Agent OK."

# Chemin et permissions pour l'authentification +
# vsz_limit à 2 Go max pour pouvoir manipuler de fortes
# fonctions de chiffrement de clefs comme Argon2 :
service auth {
	unix_listener /var/spool/postfix/private/auth {
		group = postfix
		user = postfix
		mode = 0666
	}
	vsz_limit = 2G
}

service auth-worker {
	vsz_limit = 2G
}

service lmtp {
	unix_listener /var/spool/postfix/private/dovecot-lmtp {
		group = postfix
		user = postfix
		mode = 0666
	}
}

# ID par défaut des utilisateurs virtuels :
mail_uid=5000
mail_gid=5000

# Authentification via la base MySQL :
passdb sql {
	driver = sql
	passdb_sql_args = /etc/dovecot/dovecot-sql.conf.ext
}
userdb prefetch {
	driver = prefetch
}
userdb sql {
	driver = sql
	userdb_sql_args = /etc/dovecot/dovecot-sql.conf.ext
}

# Règles des plugins pour le quota et le chiffrement :
plugin {
	# Le quota par défaut si aucun paramètre ne figure dans le fichier des
	# users. La corbeille a 10% de plus du total du quota pour permettre au
	# user de nettoyer sa boite si elle est hors quota.
	# Messages limités à 30 Mo max, mais la taille du SPAM est ignorée car
	# nettoyé régulièrement :
	quota = maildir:User quota
	quota_rule = *:storage=5G
	quota_rule2 = Trash:storage=+10%%
	quota_rule3 = SPAM:ignore
	quota_max_mail_size = 30M
	quota_over_flag_value = TRUE
	quota_grace = 10%%
	quota_status_success = DUNNO
	quota_status_nouser = DUNNO
	quota_status_overquota = "552 5.2.2 Mailbox is full"
	
	# Règles du plugin mail_crypt (chiffrement du stockage des mails) :
	mail_crypt_curve = secp521r1
	mail_crypt_save_version = 2
	crypt_user_key_require_encrypted = yes
}

# Règles pour Sieve :
sieve_pipe_bin_dir = /etc/dovecot/sieve

sieve_script after {
	type = after
	path = /etc/dovecot/sieve/default.sieve
}

# Règles pour les plugins de Sieve :
sieve_global_extensions {
	vnd.dovecot.pipe = yes
}

sieve_plugins {
	sieve_imapsieve = yes
	sieve_extprograms = yes
}

# Apprendre le ham en déplaçant hors du Spam :
imapsieve_from Junk {
	sieve_script ham {
		type = before
		cause = copy
		path = /etc/dovecot/sieve/learn-ham.sieve
	}
}

# Apprendre le spam en déplaçant vers le Spam :
mailbox Junk {
  sieve_script spam {
    type = before
    cause = copy
    path = /etc/dovecot/sieve/learn-spam.sieve
  }
}

# Définition du service pour gérer les quota :
service quota-status {
	executable = quota-status -p postfix
	unix_listener /var/spool/postfix/private/quota-status {
		user = postfix
	}
	client_limit = 1
}

# Format des logs :
login_log_format_elements = user=<%u> method=%m rip=%r lip=%l mpid=%e %c
login_log_format = %$: %s
deliver_log_format = msgid=%m: from=%f subject=%s size=%p %$

# Stockage des mails via NFS (stockage ZFS) + indexation :
mail_nfs_storage = yes
lock_method = dotlock
dotlock_use_excl = yes
mmap_disable=yes
mail_fsync=always
mail_nfs_index = yes

# On inscrit les utilisateurices à tous les dossiers classiques ainsi
# qu'aux dossiers perso (Shopping, etc.) et on auto-nettoie le Spam et
# la corbeille après 60 jours :
namespace inbox {
	mailbox "Sent" { 
		special_use = \Sent
		auto = subscribe
	}
	mailbox "Junk" {
		special_use = \Junk
		auto = subscribe
		autoexpunge = 60d
	}
	mailbox "Drafts" {
		special_use = \Drafts
		auto = subscribe
        }
	mailbox "Trash" { 
		special_use = \Trash
		auto = subscribe
		autoexpunge = 60d
	}
	mailbox "Archives" {
		special_use = \Archive
		auto = subscribe
	}
	mailbox "to-process" {
		auto = no
	}
	inbox = yes
}

# On les abonne aussi aux sous-dossiers perso :
lda_mailbox_autosubscribe = yes

