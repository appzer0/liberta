# On active les protocoles LMTP (pour l'interne) et IMAP :
protocols = lmtp imap

# Activation du plugin de gestion des quotas :
mail_plugins = $mail_plugins quota

# Configuration IMAP (désactivé) et IMAPS :
service imap-login {
	inet_listener imap {
		port = 0
	}
	inet_listener imaps {
		port = 993
	}
}

# Protocoles IMAP : contournement de certains bugs et contraintes
# + quota + alias + chiffrement :
protocol imap {
	imap_client_workarounds = delay-newmail tb-extra-mailbox-sep
	mail_plugins = $mail_plugins imap_quota imap_sieve mailbox_alias crypt
}

# Protocoles LDA/LMTP : activation quota + règles Sieve de déplacement
# des Spams + alias + chiffrement :
protocol lda {
	mail_plugins = $mail_plugins quota sieve mailbox_alias crypt
}
protocol lmtp {
	mail_plugins = $mail_plugins quota sieve mailbox_alias crypt
}

# Emplacement des boites e-mail :
mail_location = maildir:{{ mail_data_rootdir }}/%d/%n/Maildir
mail_home = {{ mail_data_rootdir }}/%d/%n/Maildir

# Configuration SSL (algos) :
ssl = yes
ssl_prefer_server_ciphers = yes
ssl_dh = </etc/dovecot/dh.pem
ssl_min_protocol = TLSv1.2
ssl_cipher_list = ALL:!aNULL:!DES:!3DES:!MD5:!DES+MD5:!RC4

# Certificats Let's Encrypt :
ssl_cert = </etc/letsencrypt/live/{{ mail_fqdn }}/fullchain.pem
ssl_key = </etc/letsencrypt/live/{{ mail_fqdn }}/privkey.pem

# Configuration des logins :
auth_mechanisms = plain login
disable_plaintext_auth = no

# Message d'accueil :
login_greeting = "Mail Delivery Agent OK."

# Chemin et permissions pour l'authentification +
# vsz_limit à 2 Go max pour pouvoir manipuler de fortes
# fonctions de chiffrement de clefs comme Argon2 :
service auth {
	unix_listener /var/spool/postfix/private/auth {
		group = postfix
		user = postfix
		mode = 0666
	}
	vsz_limit = 2G
}

service auth-worker {
	vsz_limit = 2G
}

service lmtp {
	unix_listener /var/spool/postfix/private/dovecot-lmtp {
		group = postfix
		user = postfix
		mode = 0666
	}
}

# ID par défaut des utilisateurs virtuels :
mail_uid=5000
mail_gid=5000

# Authentification via la base MySQL :
passdb {
	driver = sql
	args = /etc/dovecot/dovecot-sql.conf.ext
}
userdb {
	driver = prefetch
}

userdb {
	driver = sql
	args = /etc/dovecot/dovecot-sql.conf.ext
}

plugin {
	# Le quota par défaut si aucun paramètre ne figure dans le fichier des
	# users. La corbeille a 10% de plus du total du quota pour permettre au
	# user de nettoyer sa boite si elle est hors quota.
	# Messages limités à 30 Mo max, mais la taille du SPAM est ignorée car
	# nettoyé régulièrement :
	quota = maildir:User quota
	quota_rule = *:storage=5G
	quota_rule2 = Trash:storage=+10%%
	quota_rule3 = SPAM:ignore
	quota_max_mail_size = 30M
	quota_over_flag_value = TRUE
	quota_grace = 10%%
	quota_status_success = DUNNO
	quota_status_nouser = DUNNO
	quota_status_overquota = "552 5.2.2 Mailbox is full"
	
	# Règles du plugin pour Sieve :
	sieve = /etc/dovecot/sieve/default.sieve
	sieve_pipe_bin_dir = /etc/dovecot/sieve
	sieve_global_extensions = +vnd.dovecot.pipe
	sieve_plugins = sieve_imapsieve sieve_extprograms
	
	# Règles du plugin crypt (chiffrement du stockage des mails) :
	mail_crypt_curve = secp521r1
	mail_crypt_save_version = 2
	crypt_secret = private_key_file:%n
	crypt_secret2 = public_key_file:%n
	private_key_file = {{ mail_data_rootdir }}/%d/%n/keys/private.pem
	public_key_file = {{ mail_data_rootdir }}/%d/%n/keys/public.pem
	mail_crypt_require_encrypted_user_key = yes
	crypt_key_password_scheme = plain
	crypt_default = yes
	crypt_auto_cipher = yes
	
	# Apprendre le spam en déplaçant vers le Spam :
	imapsieve_mailbox1_name = Junk
	imapsieve_mailbox1_causes = COPY
	imapsieve_mailbox1_before = file:/etc/dovecot/sieve/learn-spam.sieve
	
	# Apprendre le ham en déplaçant depuis le Spam vers la réception :
	imapsieve_mailbox2_name = INBOX
	imapsieve_mailbox2_from = Junk
	imapsieve_mailbox2_causes = COPY
	imapsieve_mailbox2_before = file:/etc/dovecot/sieve/learn-ham.sieve
	
	# Création d'alias pour éviter des dossiers classiques en doublon :
	mailbox_alias_old = Trash
	mailbox_alias_new = Deleted Items
	mailbox_alias_old2 = Sent
	mailbox_alias_new2 = Sent Items
}

service quota-status {
	executable = quota-status -p postfix
	unix_listener /var/spool/postfix/private/quota-status {
		user = postfix
	}
	client_limit = 1
}

# Format des logs :
login_log_format_elements = user=<%u> method=%m rip=%r lip=%l mpid=%e %c
login_log_format = %$: %s
deliver_log_format = msgid=%m: from=%f subject=%s size=%p %$

# Stockage des mails via NFS (stockage ZFS) + indexation :
mail_nfs_storage = yes
lock_method = dotlock
dotlock_use_excl = yes
mmap_disable=yes
mail_fsync=always
mail_nfs_index = yes

# On inscrit les utilisateurices à tous les dossiers classiques ainsi
# qu'aux dossiers perso (Shopping, etc.) et on auto-nettoie le Spam et
# la corbeille après 60 jours :
namespace inbox {
	mailbox "*" {
		auto = subscribe
	}
	mailbox "Sent" { 
		special_use = \Sent
		auto = subscribe
	}
	mailbox "Junk" {
		special_use = \Junk
		auto = subscribe
		autoexpunge = 60d
	}
	mailbox "Drafts" {
		special_use = \Drafts
		auto = subscribe
        }
	mailbox "Trash" { 
		special_use = \Trash
		auto = subscribe
		autoexpunge = 60d
	}
	mailbox "Archives" {
		special_use = \Archive
		auto = subscribe
	}
	inbox = yes
}

# On les abonne aussi aux sous-dossiers perso :
lda_mailbox_autosubscribe = yes

