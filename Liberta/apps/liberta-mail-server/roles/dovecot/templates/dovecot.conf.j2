# On active les protocoles LMTP (pour l'interne) et IMAP :
protocols = lmtp imap

# Activation du plugin de gestion des quotas :
mail_plugins = $mail_plugins quota

# Configuration IMAP (désactivé) et IMAPS :
service imap-login {
	inet_listener imap {
		port = 0
	}
	inet_listener imaps {
		port = 993
	}
}

# Protocoles IMAP : contournement de certains bugs et contraintes + quota :
protocol imap {
	imap_client_workarounds = delay-newmail tb-extra-mailbox-sep
	mail_plugins = $mail_plugins imap_quota imap_sieve
}

# Protocoles LDA/LMTP : activation quota + règles Sieve de déplacement des Spams :
protocol lda {
	mail_plugins = $mail_plugins quota sieve
}
protocol lmtp {
	mail_plugins = $mail_plugins quota sieve
}

# Emplacement des boites e-mail :
mail_location = maildir:"{{ mail_data_rootdir }}"/%d/%n/Maildir
mail_home = "{{ mail_data_rootdir }}"/%d/%n/Maildir

# Configuration SSL (algos) :
ssl = yes
ssl_prefer_server_ciphers = yes
ssl_dh = </etc/dovecot/dh.pem
ssl_min_protocol = TLSv1.2
ssl_cipher_list = ALL:!aNULL:!DES:!3DES:!MD5:!DES+MD5:!RC4

# Certificats Let's Encrypt :
ssl_cert = </etc/letsencrypt/live/{{ mail_fqdn }}/fullchain.pem
ssl_key = </etc/letsencrypt/live/{{ mail_fqdn }}/privkey.pem

# Configuration des logins :
auth_mechanisms = plain login
disable_plaintext_auth = no

# Message d'accueil :
login_greeting = "Mail Delivery Agent OK."

# Chemin et permissions pour l'authentification +
# vsz_limit à 2 Go max pour pouvoir manipuler de fortes
# fonctions de chiffrement de clefs comme Argon2 :
service auth {
	unix_listener /var/spool/postfix/private/auth {
		group = postfix
		user = postfix
		mode = 0666
	}
	vsz_limit = 2G
}

service auth-worker {
	vsz_limit = 2G
}

service lmtp {
	unix_listener /var/spool/postfix/private/dovecot-lmtp {
		group = postfix
		user = postfix
		mode = 0666
	}
}

# ID par défaut des utilisateurs virtuels :
mail_uid=5000
mail_gid=5000

# Authentification via la base MySQL :
passdb {
	driver = sql
	args = /etc/dovecot/dovecot-sql.conf.ext
}
userdb {
	driver = prefetch
}

userdb {
	driver = sql
	args = /etc/dovecot/dovecot-sql.conf.ext
}

# Le quota par défaut si aucun paramètre ne figure dans le fichier des users
# La corbeille a 10% de plus du total du quota pour permettre à l'utilisateur de
# nettoyer sa boite si elle est hors quota.
# Messages limités à 30 Mo max, mais la taille du SPAM est ignorée car nettoyé régulièrement.
# + Activation des règles Sieve pour déplacement des Spams :
plugin {
	quota = maildir:User quota
	quota_rule = *:storage=5G
	quota_rule2 = Trash:storage=+10%%
	quota_rule3 = SPAM:ignore
}
